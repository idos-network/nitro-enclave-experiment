FROM ubuntu:latest

RUN apt-get update && apt-get install -y --no-install-recommends --no-install-suggests \
    curl \
    iproute2 \
    libgomp1 \
    net-tools \
    socat \
    nodejs \
    npm \
    telnet \
    vim \
    openssh-server \
    iptables \
    libnbd-bin \
    nbd-client \
    cryptsetup \
    xfsprogs \
    kmod \
    file \
&& rm -rf /var/cache/apt/archives /var/lib/apt/lists/*

WORKDIR /home/test

RUN mkdir -p /home/test/logs

COPY test/ .
COPY fs.key.enc .
RUN npm install

COPY ./docker-run.sh ./run.sh
COPY boot.ash ./

COPY authorized_keys /root/.ssh/authorized_keys

RUN curl -LO https://github.com/getsops/sops/releases/download/v3.10.2/sops-v3.10.2.linux.amd64  && \
    mv sops-v3.10.2.linux.amd64 /usr/local/bin/sops && \
    chmod +x /usr/local/bin/sops

RUN echo "127.0.0.1 logs.facetec.com" | tee -a /root/extra_hosts

# AWS kms (AWS identity are on ip tables forwarded to 127.0.0.2!)
RUN echo "127.0.0.3 kms.eu-west-1.amazonaws.com" | tee -a /root/extra_hosts

EXPOSE 8080

CMD ["/bin/bash", "/home/test/boot.ash"]
